name: $(Date:yyyyMMdd)$(Rev:.r)

on: [push]

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macOS-latest]
        python-version: [3.6, 3.7]

    env:
      env_name: testenv
      conda_args: --yes --quiet --name $(env_name)
      conda_packages: pytest obspy pandas pytables flake8 flake8-black
  #  Skip any commits which don't want the CI to run
  if: "!contains(github.event.head_commit.message, 'no CI')"
  steps:
    - uses: actions/checkout@v2  # checks out the current repo

    - name: Setup Conda
      uses: s-weigand/setup-conda@v1
      with:
        update_conda: true
        python-version: ${{ matrix.python-version }}
        conda-channels: anaconda, condaforge

    - name: Python ${{ matrix.python-version }}, OS ${{ matrix.os }}
      bash: echo Python ${{ matrix.python-version }}, OS ${{ matrix.os }}

    - bash: |
        conda config --set always_yes yes --set changeps1 no
#        conda config --add channels conda-forge
#        conda update -q conda
#        conda create $(conda_args) python=$(python.version) $(conda_packages)
        conda install $(conda_packages)
        conda activate $(env_name)
        pip install -r tests/requirements.txt
        pip install -e .
      name: Create Anaconda environment

    - bash: |
        conda activate $(env_name)
        flake8
      name: flake8

    - bash: |
        source activate $(env_name)
        pytest --cov obsplus
      name: run test suite

    - bash: |
        source activate $(env_name)
        pytest obsplus --doctest-modules
      name: test docstring examples

    - bash: |
        source activate $(env_name)
        pytest docs --nbval
      name: test documentation



